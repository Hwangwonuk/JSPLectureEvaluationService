JSP 파일 업로드
파일 업로드 기능이란 게시판, 프로필 사진 설정 등으로 웹서버에 파일을 업로드 하는 기능입니다.
DB연동, 웹서버의 디스크 자원 차지 등 다양한 기능이 수행됩니다.
파일 업로드는 실제로 취약점이나 오류가 제일 많이 발생하는 부분입니다.

JSP에서 파일 업로드를 하기위해서는 COS 라이브러리가 필요합니다.
COS 라이브러리의 Multipart Request 클래스를 사용합니다.
설치경로 : http://servlets.com/cos/


JSP파일 업로드 기능 구현 순서
1. 데이터베이스 구축하기
2. 업로드 양식 페이지 작성하기
3. 데이터베이스 연동 클래스 작성하기
4. 업로드 처리 페이지 작성하기
5. 파일 다운로드 페이지 작성하기
6. 보안 코딩 적용하기(시큐어 코딩) 취약점 방어

-> 파일 업로드 심화 과정은 다음과 같습니다.
1. 파일을 다운로드 한 횟수 저장하기
2. 다중 파일 업로드 구현하기



1. 데이터베이스 구축하기

파일 업로드에서 반드시 구현되어야 할 정보는 다음의 두가지 이다.
1) 서버에 저장된 실제 파일의 이름
2) 사용자가 저장한 파일의 이름

구현하는 방법은 두가지 입니다.
1) 게시판, 프로필 등의 테이블에 파일 관련 속성을 삽입하기
2) 따로 파일 관련 테이블을 생성하기 -> 더욱 효율적이다.

/*
실습용 데이터베이스 생성
CREATE DATABASE FILE
USE FILE;
본인은 현재 있는 데이터베이스를 사용하기 때문에 생략
*/

파일업로드 테이블 생성
CREATE TABLE FILE(
fileName VARCHAR(200),       -> 사용자가 업로드를 했을 때 파일이름
fileRealName VARCHAR(200)  -> 실제 서버에 올라갈 이름
);


업로드 양식페이지 제작

데이터베이스 연동 클래스 작성하기
COS 라이브러리를 WEB-INF 폴더에 삽입합니다.

JDBC 라이브러리 또한 넣는다 (이미 넣어져있음)

FILE 테이블관련 DTO(Database Transfer Object)를 작성한다 
DAO(Database Access Object)도 작성한다 ->DTO를 이용하여 데이터베이스에 접근하고, 관련한 데이터들을 DTO에 담는 역할을 수행

 실제 프로젝트 경로에 upload 폴더를 생성(실제 파일을 업로드했을 때 업로드 파일을 담는 폴더)
C:\Users\Windows10\eclipse-workspace1\.metadata\.plugins\org.eclipse.wst.server.core\tmp0\wtpwebapps\LectureEvaluation 경로


업로드 처리 페이지 작성
uploadAction.jsp

Application 내장 객체는 전체 프로젝트에 대한 자원을 관리하는 객체이다.
서버의 실제 프로젝트 경로에서 자원을 찾을 때 가장 많이 사용합니다.



보안코딩(Secure Coding)적용하기

파일업로드 취약점으로 대표적인 것은 웹 쉘(Web shell) 업로드 취약점입니다.
CMD창, 명령프롬포트를 일종의 shell이라고 할수있는데 어떠한 서버든 쉘이 존재한다. 만약 사용자가 Shell에 접근가능하다면 cmd상의 명령어를 사용할 수 있다
때문에 반드시 막아야한다.
ex) 파일 업로드 시 jsp파일을 업로드 한다. 그다음 jsp를 실행시켜버린다.


ASP, JSP, PHP 모든 유형에서 적용이 가능한 기법입니다.

공격자는 웹 쉘을 통해 서버의 명령어를 직접 실행시키게 됩니다.

endsWith()메소드를 사용하여 지정된 확장자의 파일들만 업로드되게 만들어주었지만 취약점이 존재한다.
일단 업로드가된 뒤에 나중에 삭제하기 때문에 일종의 레이스 컨디션(Race Condition)취약점이 발생한다

만약 업로드와 업로드된 파일에 계속 반복하여 접속하는 프로그램이 있다면 경쟁상태에 빠지게된다.
하나의 스레드는 계속해서 업로드하고 다른 하나의 스레드는 계속 지우려고 하기 때문에 한번쯤은 실행되게 되어있다.
레이스 컨디션(Race Condition) 경쟁상태를 유발함으로서 한번이라도 해당파일을 실행하도록 만들어서 웹쉘 기능을 수행하게 할 수 있다.
이를 원천적으로 봉쇄하는 방법은 파일의 루트 디렉터리 밖에 업로드 폴더를 위치시키는 것입니다.



파일을 다운로드 한 횟수 저장하기
테이블에 새로운 속성 추가
ALTER TABLE FILE ADD (downloadCount INT);



다중파일 업로드 구현하기

사용자가 임의대로 업로드 할 파일의 개수를 정하도록 하고 싶다면?

자바스크립트를 이용한 클라이언트 개발이 수반되어야 한다.





